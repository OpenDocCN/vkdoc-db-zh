# 一、MongoDB 简介

Abstract

想象一下这样一个世界:使用数据库是如此简单，以至于你很快就会忘记自己正在使用它。想象一下这样一个世界:速度和可伸缩性刚刚好，不需要复杂的配置或设置。想象一下，你可以只专注于手头的任务，把事情做完，然后——只是为了改变一下——准时下班。这听起来可能有点异想天开，但是 MongoDB 承诺帮助您完成所有这些事情(甚至更多)。

想象一下这样一个世界:使用数据库是如此简单，以至于你很快就会忘记自己正在使用它。想象一下这样一个世界:速度和可伸缩性刚刚好，不需要复杂的配置或设置。想象一下，你可以只专注于手头的任务，把事情做完，然后——只是为了改变一下——准时下班。这听起来可能有点异想天开，但是 MongoDB 承诺帮助您完成所有这些事情(甚至更多)。

MongoDB(源自单词 humongous)是一种相对较新的数据库，它没有表、模式、SQL 或行的概念。它没有事务、ACID 遵从性、连接、外键或其他许多在凌晨时分容易让人头疼的特性。简而言之，MongoDB 是一个与您可能习惯的数据库非常不同的数据库，尤其是如果您过去使用过关系数据库管理系统(RDBMS)的话。事实上，你甚至可能会对缺乏所谓的“标准”功能感到惊讶。

不要害怕！在接下来的页面中，您将了解 MongoDB 的背景和指导原则，以及为什么 MongoDB 团队做出这样的设计决策。我们还将对 MongoDB 的特性列表进行一次短暂的浏览，提供足够的细节来确保您在本书的剩余部分完全迷上这个主题。

我们将从创建 MongoDB 背后的哲学和思想开始，以及一些有趣和有些争议的设计决策。我们将探索面向文档的数据库的概念，它们是如何组合在一起的，以及它们的优缺点。我们还将探索 JSON 并研究它如何应用于 MongoDB。最后，我们将逐步介绍 MongoDB 的一些显著特性。

## 回顾 MongoDB 理念

像所有项目一样，MongoDB 有一套帮助指导其开发的设计哲学。在这一节中，我们将回顾一些数据库的创建原则。

### 为正确的工作使用正确的工具

支撑 MongoDB 的最重要的理念是“一刀切”的概念。多年来，传统的关系(SQL)数据库(MongoDB 是一种面向文档的数据库)一直用于存储所有类型的内容。数据是否适合关系模型并不重要(关系模型在所有 RDBMS 数据库中使用，如 MySQL、PostgresSQL、SQLite、Oracle、MS SQL Server 等)；反正数据是塞在里面的。部分原因是，一般来说，读取和写入数据库比写入文件系统更容易(也更安全)。如果你拿起任何一本教授 PHP 的书，比如 Jason Lengstorf (Apress，2009)的《PHP for Absolute Beginners 》,你可能会发现几乎立刻就会发现数据库是用来存储信息的，而不是文件系统。这样做要容易得多。虽然将数据库用作存储箱是可行的，但开发者总是不得不逆着流程工作。当我们没有按照预期的方式使用数据库时，这通常是显而易见的；任何曾经试图用稍微复杂的数据存储信息的人都知道我们在说什么，他们必须建立五个表，然后试图把它们放在一起。

MongoDB 团队决定不创建另一个试图为每个人做所有事情的数据库。相反，该团队希望创建一个处理文档而不是行的数据库，并且速度极快、可大规模伸缩且易于使用。为了做到这一点，团队不得不留下一些特性，这意味着 MongoDB 对于某些情况来说不是理想的候选。例如，它缺乏事务支持，这意味着您不想使用 MongoDB 来编写会计应用。也就是说，MongoDB 可能非常适合上述应用的一部分(比如存储复杂数据)。不过，这不是问题，因为没有理由不能将传统的 RDBMS 用于会计组件，将 MongoDB 用于文档存储。这样的混合解决方案相当普遍，你可以在《纽约时报》网站等生产应用中看到它们。

一旦你接受了 MongoDB 可能无法解决你所有问题的想法，你就会发现 MongoDB 非常适合解决某些问题，比如分析(想想你网站的实时 Google 分析)和复杂的数据结构(例如，博客帖子和评论)。如果您仍然不相信 MongoDB 是一个严肃的数据库工具，请随意跳到“查看特性列表”一节，在那里您会发现一个令人印象深刻的 MongoDB 特性列表。

Note

缺少事务和其他传统数据库特性并不意味着 MongoDB 不稳定，也不意味着它不能用于管理重要数据。

MongoDB 设计背后的另一个关键概念是，应该总是有多个数据库副本。如果一个数据库出现故障，那么可以简单地从其他服务器恢复。因为 MongoDB 的目标是尽可能快，所以它采取了一些捷径，这使得从崩溃中恢复变得更加困难。开发者认为，最严重的崩溃很可能会导致整台计算机停止工作；这意味着，即使数据库完全恢复，它仍然不可用。记住:MongoDB 并不试图成为每个人的一切。但是对于许多目的(比如构建 web 应用)，MongoDB 可能是实现您的解决方案的一个非常棒的工具。

现在你知道 MongoDB 是从哪里来的了。它并不试图在每件事上都做到最好，它也很乐意承认它并不适合所有人。然而，对于那些选择使用它的人来说，MongoDB 提供了一个丰富的面向文档的数据库，它针对速度和可伸缩性进行了优化。它几乎可以在任何你想运行它的地方运行。MongoDB 的网站包括 Linux、Mac OS、Windows 和 Solaris 的下载。

MongoDB 在所有这些目标上都取得了成功，这就是为什么使用 MongoDB(至少对我们来说)有点像做梦一样。您不必担心将数据压缩到一个表中——只需将数据放在一起，然后传递给 MongoDB 进行处理。考虑这个真实世界的例子。Peter Membrey 最近开发的一个应用需要存储一组易贝搜索结果。可能有任意数量的结果(最多 100 个)，他需要一种简单的方法将结果与数据库中的用户关联起来。

如果 Peter 一直使用 MySQL，他将不得不设计一个表来存储数据，编写代码来存储他的结果，然后编写更多的代码来将这些数据重新组合在一起。这是一个相当常见的场景，也是大多数开发者经常面对的一个场景。通常，我们只是继续做下去；然而，对于这个项目，他使用的是 MongoDB，所以事情有点不同。

具体来说，他添加了这行代码:

`request[‘ebay_results’] = ebay_results_array`

`collection.save(request)`

在这个例子中，`request`是彼得的文档，`ebay_results`是键，`ebay_result_array`包含来自易贝的结果。第二行保存更改。当他将来访问这个文档时，他将得到与以前完全相同格式的易贝结果。他不需要任何 SQL 他不需要执行任何转换；他也不需要创建任何新表或编写任何特殊代码——MongoDB 已经工作了。他很早就完成了工作，并且按时回家了。

### 缺乏对事务的内在支持

MongoDB 开发者的另一个重要设计决策是:数据库不包含事务语义(提供数据一致性和存储保证的元素)。基于 MongoDB 简单、快速和可伸缩的目标，这是一个可靠的权衡。一旦你把那些重量级的特性留在门口，横向扩展就变得容易多了。

通常，对于传统的 RDBMS，您可以通过购买更大、更强大的机器来提高性能。这是纵向扩展，但你只能做到这一步。通过水平扩展，您可以拥有许多功能较弱的小型机器，而不是一台大型机器。从历史上看，像这样的服务器集群非常适合负载平衡网站，但由于内部设计的限制，数据库一直是个问题。

你可能会认为这种支持的缺失构成了事务的破坏者；然而，许多人忘记了 MySQL 中最流行的一种表类型(`MYISAM`—也是默认的)也不支持事务。这个事实并没有阻止 MySQL 成为并保持十多年来占主导地位的开源数据库。与开发解决方案时的大多数选择一样，使用 MongoDB 将取决于个人偏好以及权衡是否适合您的项目。

Note

MongoDB 在与至少两台服务器协同使用时提供了持久性，这是推荐的生产部署的最低要求。在主服务器本身确认数据已被接受之前，可以让主服务器等待副本服务器确认收到数据。

虽然不能保证单服务器的持久性，但这种情况在未来可能会改变，目前是一个活跃的领域。

### JSON 和 MongoDB

JSON (Java Script Object Notation)不仅仅是一种交换数据的好方法；这也是一种存储数据的好方法。RDBMS 是高度结构化的，有多个文件(表)存储各个部分。另一方面，MongoDB 将所有内容都存储在一个文档中。MongoDB 在这方面类似于 JSON，这种模型提供了一种丰富而富有表现力的数据存储方式。而且，JSON 有效地描述了给定文档中的所有内容，因此不需要事先指定文档的结构。JSON 实际上是无模式的(也就是说，它不需要模式)，因为文档可以单独更新或独立于任何其他文档进行更改。另外，JSON 还通过将所有相关数据保存在一个地方提供了出色的性能。

MongoDB 实际上并不使用 JSON 来存储数据；相反，它使用由 MongoDB 团队开发的开放数据格式，称为 BSON(发音为 Bee-Son)，是二进制 JSON 的缩写。在很大程度上，使用 BSON 而不是 JSON 不会改变您处理数据的方式。BSON 让 MongoDB 变得更快，让计算机更容易处理和搜索文档。BSON 还添加了一些标准 JSON 中没有的特性，包括添加类型来处理二进制数据的能力。我们将在本章后面的“使用面向文档的存储(BSON)”中更深入地研究 BSON。

JSON 的原始规范可以在 RFC 4627 中找到，它是由道格拉斯·克洛克福特编写的。JSON 允许复杂的数据结构以简单的、人类可读的文本格式表示，这种格式通常被认为比 XML 更容易阅读和理解。像 XML 一样，JSON 被设想为一种在 web 客户端(比如浏览器)和 web 应用之间交换数据的方式。当与它描述对象的丰富方式相结合时，它的简单性使它成为大多数开发者选择的交换格式。

您可能想知道这里的复杂数据结构是什么意思。历史上，数据是使用逗号分隔值(CSV)格式交换的(事实上，这种方法今天仍然非常普遍)。CSV 是一种简单的文本格式，用新行分隔行，用逗号分隔字段。例如，CSV 文件可能如下所示:

`Membrey, Peter, +852 1234 5678`

`Thielen, Wouter, +81 1234 5678`

人类可以查看这些信息，并很快看到正在传递什么信息。也可能不是——第三列中的号码是电话号码还是传真号码？它甚至可能是传呼机的号码。为了避免这种歧义，CSV 文件通常有一个头字段，其中第一行定义了文件中的内容。下面的代码片段将前面的示例向前推进了一步:

`Lastname, Firstname, Phone Number`

`Membrey, Peter, +852 1234 5678`

`Thielen, Wouter, +81 1234 5678`

好吧，这样好多了。但是现在假设 CSV 文件中的一些人有多个电话号码。您可以为办公室电话号码添加另一个字段，但是如果您想要多个办公室电话号码，您将面临一系列新的问题。如果您还想合并多个电子邮件地址，还会面临另一系列问题。大多数人都有不止一个地址，这些地址通常不能被整齐地定义为家庭或工作。突然间，CSV 开始显示出它的局限性。CSV 文件仅适用于存储平面的、没有重复值的数据。类似地，提供几个 CSV 文件并不少见，每个文件都有单独的信息。这些文件然后被组合(通常在 RDBMS 中)以创建整个画面。例如，一家大型零售公司可能会在每天结束时从其每个商店接收 CSV 文件形式的销售数据。这些文件必须组合在一起，公司才能看到它在某一天的表现。这个过程并不简单，而且随着所需文件数量的增加，它肯定会增加出错的几率。

XML 在很大程度上解决了这个问题，但是在大多数事情上使用 XML 有点像用大锤砸坚果:它可以工作，但是感觉有点矫枉过正。这是因为 XML 是高度可扩展的。XML 没有定义特定的数据格式，而是定义了如何定义数据格式。当您需要交换复杂且高度结构化的数据时，这可能很有用；然而，对于简单的数据交换来说，这通常会导致过多的工作。事实上，这种场景就是“XML 地狱”一词的来源

JSON 提供了一个快乐的媒介。与 CSV 不同，它可以存储结构化内容；但是与 XML 不同，JSON 使内容易于理解和使用。让我们重温一下前面的例子；但是，这次您将使用 JSON 而不是 CSV:

`{`

`"firstname": "Peter"`，

`"lastname": "Membrey"`，

`"phone_numbers": [`

`"+852 1234 5678"`，

`"+44 1234 565 555"`

`]`

`}`

在这个版本的示例中，每个 JSON 对象(或文档)都包含理解它所需的所有信息。如果你看一下`phone_numbers`，你可以看到它包含了一个不同数字的列表。这个列表可以是你想要的那样大。您还可以更具体地说明正在记录的号码类型，如下例所示:

`{`

`"firstname": "Peter"`，

`"lastname": "Membrey"`，

`"numbers": [`

`{`

`"phone": "+852 1234 5678"`

`}`，

`{`

`"fax": "+44 1234 565 555"`

`}`

`]`

`}`

这个版本的例子在某些方面做了更多的改进。现在你可以清楚地看到每个数字是什么。JSON 极具表现力，尽管手工编写 JSON 非常容易，但它通常是由软件自动生成的。例如，Python 包含一个名为(有点可预测)`json`的模块，它获取现有的 Python 对象，并自动将它们转换成 JSON。因为 JSON 在如此多的平台上得到支持和使用，所以它是交换数据的理想选择。

当您添加诸如电话号码列表之类的项目时，您实际上是在创建一个所谓的嵌入式文档。每当您添加复杂的内容，如列表(或数组，使用 JSON 中的术语)时，就会发生这种情况。一般来说，也有逻辑上的区分。例如，一个`Person`文档可能嵌入了几个`Address`文档。类似地，一个`Invoice`文档可能会嵌入许多`LineItem`文档。当然，嵌入的`Address`文档也可以有自己的嵌入文档，例如包含电话号码的文档。

当您决定如何存储信息时，就决定了是否选择嵌入特定的文档。这通常被称为模式设计。当 MongoDB 被认为是一个无模式的数据库时，提到模式设计可能显得有些奇怪。然而，虽然 MongoDB 不强迫您创建模式或强制您创建的模式，但是您仍然需要考虑如何将数据组合在一起。我们将在第 3 章中对此进行更深入的探讨。

### 采用非关系方法

提高关系数据库的性能通常很简单:购买更大、更快的服务器。这种方法非常有效，直到你没有更大的服务器可以购买。此时，唯一的选择是分散到两台服务器上。这听起来很容易，但是对于大多数数据库来说，这是一个绊脚石。例如，MySQL 和 PostgresSQL 都不能在两台服务器上运行单个数据库，这两台服务器都可以读写数据(通常称为主动/主动集群)。尽管 Oracle 可以通过其令人印象深刻的 Real Application Clusters (RAC)体系结构做到这一点，但如果您想使用该解决方案，您可能需要抵押贷款—实施基于 RAC 的解决方案需要多台服务器、共享存储和多个软件许可证。

您可能想知道为什么在两个数据库上拥有主动/主动集群如此困难。当你查询你的数据库时，数据库必须找到所有相关的数据并把它们连接在一起。RDBMS 解决方案有许多提高性能的巧妙方法，但它们都依赖于对可用数据的全面了解。这就是你碰壁的地方:当一半的数据在另一台服务器上时，这种方法根本不起作用。

当然，您可能有一个很小的数据库，它只是接收大量的请求，所以您只需要分担工作负载。不幸的是，在这里你碰到了另一堵墙。您需要确保写入第一台服务器的数据对第二台服务器可用。如果同时在两个独立的主服务器上进行更新，还会面临其他问题。例如，您需要确定哪个更新是正确的。您可能遇到的另一个问题是:有人可能会向第二个服务器查询刚刚写入第一个服务器的信息，但是该信息在第二个服务器上还没有更新。当您考虑所有这些问题时，就很容易理解为什么 Oracle 解决方案如此昂贵了—这些问题极难解决。

MongoDB 以一种非常聪明的方式解决了主动/主动集群问题——它完全避免了这些问题。回想一下，MongoDB 将数据存储在 BSON 文档中，因此数据是独立的。也就是说，尽管相似的文档存储在一起，但单个文档并不是由关系组成的。这意味着您需要的一切都在一个地方。因为 MongoDB 中的查询在文档中查找特定的键和值，所以这些信息可以很容易地传播到尽可能多的服务器上。每个服务器检查它拥有的内容并返回结果。这有效地实现了几乎线性的可伸缩性和性能。作为一个额外的奖励，它甚至不需要你拿出一个新的抵押贷款来支付这项功能。

诚然，MongoDB 不提供主/主复制，即两个独立的服务器都可以接受写请求。然而，它确实有分片，允许数据在多台机器上分割，每台机器负责更新数据集的不同部分。这种设计的好处是，虽然一些解决方案允许两个主数据库，但 MongoDB 可以像在两台机器上运行一样轻松地扩展到数百台机器。

### 选择性能还是功能

性能很重要，但是 MongoDB 也提供了大量的特性集。我们已经讨论了 MongoDB 没有实现的一些特性，您可能会对 MongoDB 部分通过明智地删除其他数据库共有的某些特性来实现其令人印象深刻的性能的说法有些怀疑。然而，有一些类似的数据库系统非常快，但也非常有限，比如那些实现键/值存储的系统。

memcached 就是一个很好的例子。这个应用是为提供高速数据缓存而编写的，它的速度快得令人麻木。当用于缓存网站内容时，它可以将应用的速度提高许多倍。这个应用被非常大的网站使用，例如脸书和 LiveJournal。

问题是这个应用有两个明显的缺点。首先，它是一个只读的数据库。如果停电，所有的数据都会丢失。第二，你实际上不能使用 memcached 搜索数据；您只能请求特定的密钥。

这些听起来像是严重的限制；但是，您必须记住 memcached 旨在解决的问题。首先，memcached 是一个数据缓存。也就是说，它不应该是一个永久的数据存储，而只是为现有的数据库提供一个缓存层。当您构建动态网页时，您通常会请求非常具体的数据(例如当前排名前十的文章)。这意味着您可以专门向 memcached 请求该数据——不需要执行搜索。如果缓存过期或为空，您应该像往常一样查询数据库，构建数据，然后将其存储在 memcached 中以备将来使用。

一旦您接受了这些限制，您就可以看到 memcached 如何通过实现非常有限的特性集来提供卓越的性能。顺便说一下，这种性能是传统数据库无法比拟的。也就是说，memcached 肯定不能取代 RDBMS。要记住的重要一点是，这是不应该的。

与 memcached 相比，MongoDB 本身功能丰富。为了有用，MongoDB 必须提供一组强大的特性，比如搜索特定文档的能力。它还必须能够将这些文档存储在磁盘上，这样它们就可以在重启后继续存在。幸运的是，MongoDB 提供了足够的特性，可以成为大多数 web 应用和许多其他类型应用的有力竞争者。

和 memcached 一样，MongoDB 也不是一个通用的数据库。与计算中的通常情况一样，必须做出权衡来实现应用的预期目标。

### 在任何地方运行数据库

MongoDB 是用 C++编写的，这使得在任何地方移植和/或运行应用都相对容易。目前，可以从 MongoDB 网站下载适用于 Linux、Mac OS、Windows 和 Solaris 的二进制文件。除了其他平台之外，Fedora 和 CentOS 也有各种官方版本。您甚至可以下载源代码并构建自己的 MongoDB，尽管建议您尽可能使用提供的二进制文件。所有二进制文件都有 32 位和 64 位版本。

Caution

32 位版本的 MongoDB 仅限于 2GB 或更小的数据库。这是因为 MongoDB 在内部使用内存映射文件来实现高性能。在 32 位系统上，任何大于 2GB 的内存都需要一些花哨的动作，这些动作不会很快，还会使应用的代码变得复杂。官方对此限制的立场是 64 位环境很容易获得；因此，增加代码复杂性不是一个好的权衡。实际上，64 位版本没有这样的限制。

MongoDB 的适度要求允许它运行在高性能的服务器或虚拟机上，甚至支持基于云的应用。通过保持简单并关注速度和效率，MongoDB 可以在您选择部署它的任何地方提供稳定的性能。

## 将所有东西组装在一起

在我们查看 MongoDB 的特性列表之前，我们需要回顾几个基本术语。MongoDB 不需要太多的专业知识就可以开始使用，许多 MongoDB 特有的术语可以粗略地翻译成您可能已经熟悉的 RDBMS 对等术语。不过，不要担心；我们将详细解释每个术语。即使您不熟悉标准的数据库术语，您仍然能够轻松理解。

### 生成或创建密钥

文档代表 MongoDB 中的存储单元。在 RDBMS 中，这将被称为行。然而，文档不仅仅是行，因为它们可以存储复杂的信息，比如列表、字典，甚至字典列表。与行是固定的传统数据库相比，MongoDB 中的文档可以由任意数量的键和值组成(您将在下一节中了解更多)。归根结底，一个键只不过是一个标签；它大致相当于您可能给 RDBMS 中的列起的名字。您使用一个键来引用文档中的数据。

在关系数据库中，应该总是有某种方法来唯一地标识给定的记录；否则就不可能引用特定的行。为此，应该包含一个保存唯一值的字段(称为主键)或一个可以唯一标识给定行的字段集合(称为复合主键)。

出于同样的原因，MongoDB 要求每个文档有一个惟一的标识符；在 MongoDB 中，这个标识符被称为`_id`。除非您为这个字段指定一个值，否则 MongoDB 将为您生成一个唯一的值。即使在成熟的 RDBMS 数据库中，对于是应该使用数据库提供的惟一键还是自己生成惟一键，也有不同的意见。最近，允许数据库为您创建密钥变得越来越流行。

其原因是人类创造的独特号码，如汽车注册号码，有一个令人讨厌的变化习惯。例如，2001 年，英国实施了与以前的系统完全不同的新的号牌方案。恰好 MongoDB 可以很好地应对这种类型的变化；但是，如果您使用牌照作为主键，您可能需要仔细考虑。当 ISBN(国际标准书号)方案从 10 位数字升级到 13 位数字时，可能会出现类似的情况。

以前，大多数使用 MongoDB 的开发者似乎更喜欢创建他们自己的惟一键，自己承担这一任务以确保数字保持惟一。但是今天，大多数人似乎都倾向于使用 MongoDB 为您创建的默认 ID 值。然而，就像使用 RDBMS 数据库一样，您选择的方法主要取决于个人偏好。我们更喜欢使用数据库提供的值，因为这意味着我们可以确保这个键是惟一的，并且独立于其他任何东西。如上所述，其他人更喜欢提供他们自己的密钥。

最终，你必须决定什么最适合你。如果您确信您的密钥是唯一的(并且可能保持不变)，那么您应该可以随意使用它。如果您不确定您的密钥的唯一性或者您不想担心它，那么您可以简单地使用 MongoDB 提供的默认密钥。

### 使用键和值

文档由键和值组成。让我们再看一下本章前面讨论的例子:

`{`

`"firstname": "Peter"`，

`"lastname": "Membrey"`，

`"phone_numbers": [`

`"+852 1234 5678"`，

`"+44 1234 565 555"`

`]`

`}`

键和值总是成对出现。与 RDBMS 不同，在 RDBMS 中，每个字段都必须有一个值，即使它是`NULL`(有点矛盾，这意味着未知)，MongoDB 不要求文档有一个特定的值。例如，如果你不知道名单上某个人的电话号码，你就干脆把它删掉。这类事情的一个流行比喻是名片。如果你有传真号码，你通常会把它放在你的名片上；然而，如果你没有，你不写:“传真号码:无。”相反，你可以简单地忽略这些信息。如果 MongoDB 文档中没有包含键/值对，则认为它不存在。

### 实现集合

集合有点类似于表，但是它们远没有那么严格。收藏很像一个贴有标签的盒子。你家里可能有一个标有“DVD”的盒子，你可以把你的 DVD 放进去。这很有道理，但是如果你想的话，没有什么可以阻止你把 CD 甚至磁带放进这个盒子里。在 RDBMS 中，表是严格定义的，只能将指定的项放入表中。在 MongoDB 中，集合就是:相似项目的集合。条目不必相似(MongoDB 天生灵活)；然而，一旦我们开始研究索引和更高级的查询，您很快就会看到在集合中放置相似项目的好处。

虽然你可以在一个系列中混合不同的物品，但没必要这样做。如果这个收藏被称为`media`，那么所有的 DVD、CD 和磁带都会在那里。毕竟，这些项目都有共同点，如艺术家姓名、发行日期和内容。换句话说，某些文档是否应该存储在同一个集合中确实取决于您的应用。就性能而言，拥有多个集合并不比只有一个集合慢。记住:MongoDB 是为了让你的生活更简单，所以你应该做任何你觉得对的事情。

最后但并非最不重要的一点是，集合是按需有效创建的。具体来说，当您第一次尝试保存引用集合的文档时，会创建一个集合。这意味着您可以按需创建集合(并不是说您必须这样做)。因为 MongoDB 还允许您动态地创建索引和执行其他数据库级命令，所以您可以利用这种行为来构建一些非常动态的应用。

### 了解数据库

也许在 MongoDB 中，将数据库视为集合的集合是最简单的方式。像集合一样，数据库可以按需创建。这意味着为每个客户创建一个数据库很容易——您的应用代码甚至可以为您做到这一点。除了 MongoDB 之外，您还可以使用其他数据库来实现这一点；然而，用 MongoDB 以这种方式创建数据库是一个非常自然的过程。也就是说，仅仅因为您可以用这种方式创建数据库，并不意味着您必须这样做，甚至不意味着您应该这样做。尽管如此，如果你想行使这种权力，你就有这种权力。

## 查看功能列表

现在您已经了解了 MongoDB 是什么以及它提供了什么，是时候浏览一下它的特性列表了。你可以在数据库网站 [`www.mongodb.org/`](http://www.mongodb.org/) 找到 MongoDB 特性的完整列表；请务必访问该网站，获取最新列表。本章中的特性列表涵盖了相当多的幕后内容，但是使用 MongoDB 本身并不需要熟悉列出的每个特性。换句话说，如果你在回顾这个列表的时候感觉到你的眼睛开始闭上了，请随意跳到这一部分的末尾！

### 使用面向文档的存储(BSON)

我们已经讨论了 MongoDB 的面向文档的设计。我们也简要介绍了 BSON。正如您所了解的，JSON 使得以真实形式存储和检索文档变得更加容易，有效地消除了对任何类型的映射器或特殊转换代码的需求。这个特性也使得 MongoDB 更容易扩展，这是锦上添花。

BSON 是一个开放的标准；你可以在 [`http://bsonspec.org/`](http://bsonspec.org/) 找到它的规格。当人们听说 BSON 是 JSON 的二进制形式时，他们希望它比基于文本的 JSON 占用更少的空间。然而，这不一定是事实；事实上，在很多情况下，BSON 版本比 JSON 版本占用更多的空间。

你可能想知道为什么你应该使用 BSON。毕竟，CouchDB(另一个强大的面向文档的数据库)使用纯 JSON，因此有理由怀疑是否值得在 BSON 和 JSON 之间来回转换文档。

首先，我们必须记住，MongoDB 旨在提高速度，而不是节省空间。这并不意味着 MongoDB 浪费空间(它没有)；然而，存储文档的少量开销是完全可以接受的，如果这样可以更快地处理数据的话(事实就是如此)。简而言之，BSON 更容易遍历(也就是说，浏览)和索引非常快。虽然 BSON 比 JSON 需要稍微多一点的磁盘空间，但是这种额外的空间不太可能成为问题，因为磁盘很便宜，而且 MongoDB 可以跨机器伸缩。这种情况下的折衷是很合理的:您可以用一点额外的磁盘空间来换取更好的查询和索引性能。

使用 BSON 的第二个主要好处是，可以方便快捷地将 BSON 转换成编程语言的本地数据格式。如果数据存储在纯 JSON 中，就需要进行相对高级别的转换。大量编程语言(如 Python、Ruby、PHP、C、C++和 C#)都有 MongoDB 驱动程序，每种驱动程序的工作方式都略有不同。使用简单的二进制格式，可以为每种语言快速构建原生数据结构，而不需要首先处理 JSON。这使得代码更简单、更快，这两者都符合 MongoDB 的既定目标。

BSON 也为 JSON 提供了一些扩展。例如，它使您能够存储二进制数据并合并特定的数据类型。因此，虽然 BSON 可以存储任何 JSON 文档，但有效的 BSON 文档可能不是有效的 JSON。这没关系，因为每种语言都有自己的驱动程序，可以在 BSON 之间来回转换数据，而不需要使用 JSON 作为中间语言。

归根结底，BSON 不太可能成为您使用 MongoDB 的重要因素。像所有伟大的工具一样，MongoDB 将静静地坐在后台，做它需要做的事情。除了可能使用图形工具来查看数据之外，您通常会使用您的母语工作，并让驱动程序担心如何持久化 MongoDB。

### 支持动态查询

MongoDB 对动态查询的支持意味着您可以运行一个查询，而无需事先计划。这类似于能够对 RDBMS 运行 SQL 查询。你可能想知道为什么这被列为一个特性；当然，这是每个数据库都支持的东西，对吗？

其实不是，比如 CouchDB(一般认为是 MongoDB 最大的“竞争对手”)不支持动态查询。这是因为 CouchDB 提出了一种全新的(当然也是令人兴奋的)思考数据的方式。传统的 RDBMS 有静态数据和动态查询。这意味着数据的结构是预先固定的——必须定义表，并且每一行都必须适合该结构。因为数据库预先知道数据的结构，所以它可以做出某些假设和优化，从而实现快速的动态查询。

CouchDB 彻底颠覆了这一点。作为一个面向文档的数据库，CouchDB 是无模式的，所以数据是动态的。然而，这里的新思想是查询是静态的。也就是说，在使用它们之前，您需要预先定义它们。

这并不像听起来那么糟糕，因为许多查询可以很容易地预先定义。例如，一个让你搜索一本书的系统可能会让你通过 ISBN 来搜索。在 CouchDB 中，您将创建一个索引，为所有文档构建一个 ISBNs 列表。当你输入 ISBN 时，查询速度非常快，因为它实际上不需要搜索任何数据。每当有新数据添加到系统中时，CouchDB 都会自动更新其索引。

从技术上讲，您可以针对 CouchDB 运行查询，而无需生成索引；然而，在这种情况下，CouchDB 必须先创建索引，然后才能处理您的查询。如果你只有一百本书，这就不是问题；然而，如果您要归档几十万本书，这会导致性能下降，因为每个查询都会一次又一次地生成索引。出于这个原因，CouchDB 团队不建议在生产中使用动态查询——即没有预定义的查询。

CouchDB 还允许您将查询写成`map`和`reduce`函数。如果这听起来像是很大的努力，那么你在一个好公司；CouchDB 的学习曲线有些严峻。公平地说，一个有经验的程序员可能会很快掌握它；然而，对于大多数人来说，学习曲线可能太陡了，以至于他们不愿意使用这个工具。

幸运的是，对于我们这些凡人来说，MongoDB 更容易使用。我们将在整本书中更详细地介绍如何使用 MongoDB，但这里有一个简短的版本:在 MongoDB 中，您只需提供想要匹配的文档部分，MongoDB 会完成其余部分。然而，MongoDB 可以做得更多。比如你想用`map`或者`reduce`函数就不会发现 MongoDB 缺少。同时，您可以轻松地使用 MongoDB 您不必预先了解该工具的所有高级特性。

### 为您的文档编制索引

MongoDB 包括对文档索引的广泛支持，当您处理成千上万的文档时，这个特性真的很方便。如果没有索引，MongoDB 将不得不依次查看每个单独的文档，以确定它是否是您想要查看的内容。这就像向图书管理员要一本书，然后看着他在库里走来走去，看每一本书。有了索引系统(库倾向于使用杜威十进制系统)，他可以找到你要找的书所在的区域，并很快确定它是否在那里。

与库的书不同，MongoDB 中的所有文档都在`_id`键上自动索引。该键被视为特殊情况，因为您不能删除它；索引确保每个值都是唯一的。这个键的好处之一是可以保证每个文档都是唯一可识别的，而 RDBMS 不能保证这一点。

当您创建自己的索引时，您可以决定是否希望它们强制唯一性。如果您决定创建一个惟一的索引，您可以告诉 MongoDB 删除所有重复的索引。这可能是也可能不是您想要的，所以在使用此选项之前您应该仔细考虑，因为您可能会意外删除一半的数据。默认情况下，如果您尝试在具有重复值的键上创建唯一索引，将会返回错误。

在许多情况下，您会希望创建一个允许重复的索引。例如，如果您的应用按姓氏进行搜索，那么在姓氏键上建立索引是有意义的。当然，您不能保证每个姓氏都是唯一的；并且在任何合理大小的数据库中，副本实际上是可以保证的。

然而，MongoDB 的索引能力并不止于此。MongoDB 还可以在嵌入式文档上创建索引。例如，如果您在 address 键中存储了大量地址，则可以根据邮政编码创建一个索引。这意味着您可以基于任何邮政编码轻松地撤回文档，而且速度非常快。

MongoDB 通过允许复合索引更进一步。在复合索引中，两个或多个键用于构建给定的索引。例如，您可以构建一个结合了`lastname`和`firstname`标签的索引。搜索全名会非常快，因为 MongoDB 可以快速分离出姓，然后同样快速地分离出名。

我们将在第 10 章中更深入地研究索引，但只要说 MongoDB 已经涵盖了索引就够了。

### 利用地理空间索引

值得一提的一种索引形式是地理空间索引。MongoDB 1.4 中引入了这种新的专门的索引技术。您可以使用此功能来索引基于位置的数据，使您能够回答查询，例如在给定坐标集的特定距离内有多少项目。

随着越来越多的 web 应用开始利用基于位置的数据，这一特性将在日常开发中扮演越来越重要的角色。不过，就目前而言，地理空间索引仍然是一个小众功能；然而，如果你发现你需要它，你会很高兴它就在那里。

### 分析查询

一个内置的分析工具可以让您看到 MongoDB 是如何确定返回哪些文档的。这很有用，因为在许多情况下，只需添加一个索引就可以轻松地改进查询。如果您有一个复杂的查询，并且您不确定它为什么运行得这么慢，那么查询分析器可以为您提供非常有价值的信息。同样，您将在第 10 章中了解更多关于 MongoDB Profiler 的信息。

### 就地更新信息

当数据库更新一行(或者在 MongoDB 的情况下，更新一个文档)时，它有两种选择。许多数据库选择多版本并发控制(MVCC)方法，这种方法允许多个用户查看不同版本的数据。这种方法很有用，因为它确保了在给定的事务中，数据不会被另一个程序中途更改。

这种方法的缺点是数据库需要跟踪数据的多个副本。例如，CouchDB 提供了非常强大的版本控制，但这是以写出全部数据为代价的。虽然这确保了数据以可靠的方式存储，但也增加了复杂性并降低了性能。

另一方面，MongoDB 就地更新信息。这意味着(与 CouchDB 相反)MongoDB 可以在任何地方更新数据。这通常意味着不需要分配额外的空间，索引可以保持不变。

这种方法的另一个好处是 MongoDB 执行延迟写入。读写内存的速度非常快，但是写到磁盘要慢上千倍。这意味着您希望尽可能地限制对磁盘的读写。这在 CouchDB 中是不可能的，因为该程序确保每个文档都被快速写入磁盘。虽然这种方法可以保证数据安全地写入磁盘，但它也会显著影响性能。

MongoDB 只有在必要时才会写入磁盘，通常是每秒钟一次左右。这意味着，如果一个值每秒钟被更新多次——如果您将一个值用作页面计数器或用于实时统计，这种情况并不少见——那么该值将只被写入一次，而不是 CouchDB 要求的数千次。

这种方法使得 MongoDB 速度更快，但是，同样，这也是有代价的。CouchDB 可能比较慢，但它确实保证了数据安全地存储在磁盘上。MongoDB 没有这样的保证，这就是为什么传统的 RDBMS 可能是管理关键数据(如账单或应收账款)的更好的解决方案。

### 存储二进制数据

GridFS 是 MongoDB 在数据库中存储二进制数据的解决方案。BSON 支持在一个文档中保存高达 4MB 的二进制数据，这可能足以满足您的需求。例如，如果您想要存储个人资料图片或声音剪辑，那么 4MB 的空间可能会超出您的需要。另一方面，如果您想要存储电影剪辑、高质量的音频剪辑，甚至是几百兆大小的文件，那么 MongoDB 也可以满足您的需求。

GridFS 的工作原理是将关于文件的信息(称为元数据)存储在`files`集合中。数据本身被分解成称为块的片段，存储在`chunks`集合中。这种方法使得存储数据既容易又可伸缩；它还使得范围操作(例如检索文件的特定部分)更易于使用。

一般来说，您会通过编程语言的 MongoDB 驱动程序来使用 GridFS，所以您不太可能在这么低的级别上动手。和 MongoDB 中的其他东西一样，GridFS 是为速度和可伸缩性而设计的。这意味着，如果您想处理大型数据文件，MongoDB 可以胜任这项任务。

### 复制数据

当我们谈到 MongoDB 背后的指导原则时，我们提到 RDBMS 数据库为数据存储提供了 MongoDB 中所没有的某些保证。这些保证由于一些原因没有实现。首先，这些特性会降低数据库的速度。其次，它们会大大增加程序的复杂性。第三，人们认为服务器上最常见的故障是硬件故障，这将使数据无法使用，即使数据被安全地保存在磁盘上。

当然，这并不意味着数据安全不重要。如果您不能指望在需要时能够访问数据，那么 MongoDB 就没有多大用处。最初，MongoDB 提供了一个具有主从复制特性的安全网，其中在任何给定时间只有一个数据库是活动的，这种方法在 RDBMS 领域也很常见。这个特性已经被副本集所取代，基本的主从复制已经被废弃，不应该再使用了。

副本集有一个主服务器(类似于主服务器)，它处理来自客户端的所有写请求。因为在给定的集中只有一个主服务器，所以它可以保证所有的写操作都得到正确的处理。发生写入时，会记录在主服务器的“操作日志”中。

操作日志由辅助服务器(可以有多个)复制，并用于使它们自己与主服务器保持同步。如果主节点在任何给定时间出现故障，其中一个辅助节点将成为主节点，并接管处理客户端写入请求的责任。

### 实现分片

对于那些参与大规模部署的人来说，自动分片可能是 MongoDB 最重要和最常用的特性之一。

在自动分片场景中，MongoDB 会为您处理所有的数据拆分和重组。它确保数据到达正确的服务器，并以最有效的方式运行和组合查询。事实上，从开发者的角度来看，与拥有一百个分片的 MongoDB 数据库对话和与单个 MongoDB 服务器对话没有任何区别。此功能尚未投入生产；然而，当它实现时，它将推动 MongoDB 的可伸缩性。

与此同时，如果您刚刚起步或者正在构建您的第一个基于 MongoDB 的网站，那么您可能会发现一个 MongoDB 实例就足以满足您的需求。然而，如果你最终建立了下一个脸书或亚马逊，你会很高兴你的网站建立在一种可以无限扩展的技术上。分片是本书第 12 章的主题。

### 使用 Map 和 Reduce 函数

对许多人来说，听到 MapReduce 这个词会让他们不寒而栗。在另一个极端，许多 RDBMS 的拥护者嘲笑`map`和`reduce`函数的复杂性。这对一些人来说很可怕，因为这些函数需要一种完全不同的方式来寻找和排序数据，许多专业程序员很难理解支撑`map`和`reduce`函数的概念。也就是说，这些函数提供了一种极其强大的数据查询方式。事实上，CouchDB 只支持这种方法，这也是它具有如此高的学习曲线的一个原因。

MongoDB 不要求您使用`map`和`reduce`函数。事实上，MongoDB 依赖于一个简单的查询语法，更类似于 MySQL 中的语法。然而，MongoDB 确实为那些想要的人提供了这些功能。`map`和`reduce`函数是用 JavaScript 编写的，在服务器上运行。`map`功能的任务是找到所有符合特定标准的文档。这些结果随后被传递给处理数据的`reduce`函数。`reduce`函数通常不返回文档集合；相反，它返回一个包含派生信息的新文档。一般来说，如果您通常在 SQL 中使用 GROUP BY，那么`map`和`reduce`函数可能是 MongoDB 中的合适工具。

Note

您不应该认为 MongoDB 的`map`和`reduce`函数是 CouchDB 所采用方法的拙劣模仿。如果您愿意，可以使用 MongoDB 的`map`和`reduce`函数来代替 MongoDB 固有的查询支持。

### 全新的聚合框架

MapReduce 是一个非常强大的工具，但是它有一个主要的缺点；它不太容易使用。许多数据库系统用于报告，特别是 SQL 数据库使这变得非常容易。如果你想对结果进行分组或者找出最大值和平均值，那么表达这个想法并得到你想要的结果是非常简单的。不幸的是，在 MapReduce 中实现这一点并不那么简单，实际上您必须自己完成所有的连接。这通常意味着一个简单的任务是不必要的挑战。

为了应对这种情况，MongoDB Inc(以前的 10gen)添加了聚合框架。它是基于管道的，允许您获取查询的各个部分，并将它们串在一起，以获得您想要的结果。这保持了 MongoDB 面向文档设计的优点，同时还提供了高性能。

因此，如果您需要 MapReduce 的所有功能，您仍然可以随时调用它。如果你只是想做一些基本的统计和数字处理，你会爱上新的聚合框架。你将在第 4 章和第 6 章中了解更多关于聚合框架及其命令的信息。

## 获得帮助

MongoDB 有一个很棒的社区，核心开发者非常活跃，容易接近，他们通常会竭尽全力帮助社区的其他成员。MongoDB 易于使用，并附带了很棒的文档；然而，知道你不是一个人，并且在你需要的时候有帮助是很好的。

### 访问网站

寻找更新信息或帮助的第一个地方是 MongoDB 网站(`www://mongodb.org`)。这个网站定期更新，包含所有最新的 MongoDB 优点。在这个站点上，您可以找到驱动程序、教程、示例、常见问题以及更多内容。

### 与 MongoDB 开发者聊天

MongoDB 开发者在 Freenode 网络上的`#MongoDB`([`www.freenode.net`](http://www.freenode.net/))挂在互联网中继聊天(IRC)上。MongoDB 的开发者在纽约，但他们经常在这个频道聊天到深夜。当然，开发者确实需要在某个时候睡觉(咖啡只能工作这么久！);幸运的是，也有许多来自世界各地的知识渊博的 MongoDB 用户准备提供帮助。许多访问`#MongoDB`频道的人不是专家；然而，这里的气氛非常友好，所以他们还是留了下来。请随时加入`#MongoDB`频道，与那里的人们聊天——你可能会发现一些很棒的提示和技巧。如果你真的卡住了，你可能会很快回到正轨。

### 剪切和粘贴 MongoDB 代码

Pastie ( [`http://pastie.org`](http://pastie.org/) )严格来说不是 MongoDB 网站；然而，如果你在`#MongoDB`中漂浮任意长的时间，你都会遇到它。Pastie 网站基本上允许你剪切和粘贴(因此得名)一些输出或程序代码，然后放到网上供他人查看。在 IRC 中，粘贴多行文本可能会很混乱或者难以阅读。如果你需要发布一些文字(比如三行或更多)，那么你应该访问 [`http://pastie.org`](http://pastie.org/) ，粘贴你的内容，然后将链接粘贴到你的新页面。

### 在谷歌群组上寻找解决方案

MongoDB 还有一个 Google 组叫做`mongodb-user` ( [`http://groups.google.com/group/mongodb-user`](http://groups.google.com/group/mongodb-user) )。这个群是一个提问或寻找答案的好地方。您还可以通过电子邮件与小组互动。与非常短暂的 IRC 不同，Google group 是一个伟大的长期资源。如果你真的想加入 MongoDB 社区，加入这个团体是一个很好的开始。

### 利用 JIRA 跟踪系统

MongoDB 使用 JIRA 问题跟踪系统。您可以在 [`http://jira.mongodb.org/`](http://jira.mongodb.org/) 查看跟踪站点，并积极鼓励您向该站点报告您遇到的任何错误或问题。社区认为报告此类问题是一件真正的好事。当然，您也可以搜索以前的版本，甚至可以查看下一个版本的路线图和计划更新。

如果你以前没有在 JIRA 发过帖子，你可能想先去参观一下 IRC 房间。你会很快发现你是否发现了新的东西，如果是这样，你会看到如何去报道它。

## 摘要

本章简要介绍了 MongoDB 带来的好处。我们已经了解了 MongoDB 创建和开发背后的哲学和指导原则，以及 MongoDB 开发者在实现这些理念时所做的权衡。我们还研究了与 MongoDB 结合使用的一些关键术语，它们是如何结合在一起的，以及它们大致的 SQL 对等词。

接下来，我们研究了 MongoDB 提供的一些特性，包括如何以及在什么地方使用它们。最后，我们简要介绍了社区的概况，以及在需要帮助时可以去哪里寻求帮助。