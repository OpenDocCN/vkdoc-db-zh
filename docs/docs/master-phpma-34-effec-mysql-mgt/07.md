# 七、结构和数据导入

在本章中，我们将学习如何导入出于备份或传输目的而导出的数据。导出的数据也可以来自其他应用程序的作者，并且可以包含这些应用程序的整个基础结构，以及一些示例数据。

当前 phpMyAdmin 版本（3.4）可以导入以下内容：

*   包含 MySQL 语句的文件（通常具有 `.sql`后缀，但不一定如此）
*   CSV 文件（逗号分隔的值，尽管分隔符不一定是逗号）；这些文件可以由 phpMyAdmin 本身导入，也可以通过 MySQL `LOAD DATA INFILE`语句导入，MySQL 服务器可以直接处理数据，而不需要 phpMyAdmin 先解析
*   打开文档电子表文件
*   XML 文件（由 phpMyAdmin 生成）

[第 5 章](05.html "Chapter 5. Changing Data and Structure")中所述的二进制列上传可以说属于 import 系列。

### 注

导入和上载在此上下文中是同义词。

通常，导出的文件可以导入到它来自的同一数据库或任何其他数据库；XML 格式是一个例外，本章后面的 XML 部分给出了一个解决方法。此外，从较旧的 phpMyAdmin 版本生成的文件在当前版本导入时应该没有问题，但是导出时的 MySQL 版本与导入时的 MySQL 版本之间的差异可能在兼容性方面起到更大的作用。很难评估未来的 MySQL 版本将如何改变该语言的语法，从而带来导入挑战。

可从多个面板访问导入功能：

*   从主页、 `Database`视图或 `Table`视图提供的**导入**菜单
*   查询窗口内提供的**导入文件**菜单（如[第 11 章](11.html "Chapter 11. Entering SQL Statements")所述）

`Import`接口的默认值在 `$cfg['Import']`中定义。

在检查实际导入对话框之前，让我们讨论一些限制问题。

# 转让限制

导入时，源文件通常位于客户机上，因此必须通过 HTTP 传输到服务器。此传输需要时间并使用 web 服务器 PHP 配置中可能受限的资源。

不使用 HTTP，我们可以使用 FTP 等协议将文件上传到服务器，如*从 web 服务器上传目录*读取文件部分所述。此方法绕过了 web 服务器的 PHP 上载限制。

## 时限

首先，让我们考虑时限。在 `config.inc.php`中， `$cfg['ExecTimeLimit']`配置指令默认为任何 phpMyAdmin 脚本分配 300 秒（五分钟）的最长执行时间，包括上传文件后处理数据的脚本。 `0`的值消除了限制，理论上，为我们提供了无限的时间来完成导入操作。如果 PHP 服务器在安全模式下运行，修改 `$cfg['ExecTimeLimit']`将无效。这是因为 `php.ini`或与用户相关的 web 服务器配置文件（如 `.htaccess`或虚拟主机配置文件）中设置的限制优先于此参数。

当然，它所需的时间取决于两个关键因素：

*   Web 服务器负载
*   MySQL 服务器负载

### 注

文件在客户端和服务器之间传输所花费的时间不算作执行时间，因为 PHP 脚本仅在服务器接收到文件后才开始执行。因此， `$cfg['ExecTimeLimit']`参数只影响处理数据的时间（如解压或发送到 MySQL 服务器）。

## 其他限制

系统管理员可以使用 `php.ini`文件或 web 服务器的虚拟主机配置文件来控制服务器上的上传。

`upload_max_filesize`参数指定可通过 HTTP 上传的文件大小上限或最大值。这一个很明显，但另一个不太明显的参数是 `post_max_size`。由于 HTTP 上传是通过 POST 方法完成的，因此此参数可能会限制我们的传输。有关 POST 方法的更多详细信息，请参阅[http://en.wikipedia.org/wiki/Http#Request_methods](http://en.wikipedia.org/wiki/Http#Request_methods) 。

提供 `memory_limit`参数是为了防止 web 服务器子进程占用在子进程内运行的服务器太多内存 phpMyAdmin。因此，给这个参数一个小值可能会影响正常文件上传（尤其是压缩转储）的处理。这里，不能推荐首选值；该值取决于我们想要处理的上传数据的大小和物理内存的大小。内存限制也可以通过 `config.inc.php`中的 `$cfg['MemoryLimit']`参数进行调整，如[第 6 章](06.html "Chapter 6. Exporting Structure and Data (Backup)")所示。

最后，必须通过将 `file_uploads`设置为 `On`来允许文件上传；否则，phpMyAdmin 甚至不会显示选择文件的对话框。显示此对话框是无用的，因为连接稍后会被 web 服务器的 PHP 组件拒绝。

## 处理大型导出文件

如果文件太大，我们有办法解决这种情况。如果原始数据仍然可以通过 phpMyAdmin 访问，我们可以使用 phpMyAdmin 生成较小的导出文件，选择**转储一些行**对话框。如果这是不可能的，我们可以使用电子表程序或文本编辑器将文件分割成更小的部分。另一种可能是使用**上传目录机制**，该机制访问 `$cfg['UploadDir']`中定义的目录。本章后面将解释此功能。

在最近的 phpMyAdmin 版本中，**部分导入**功能也可以解决此文件大小问题。通过选中**允许中断…**复选框，导入过程将在检测到接近时间限制时自行中断。我们还可以指定从一开始就要跳过的查询数量，以防我们成功导入多行并希望从该点继续。

## 上传到临时目录

在服务器上，名为 `open_basedir`的 PHP 安全功能（将 PHP 可以打开的文件限制在指定的目录树中）可能会妨碍上载机制。在这种情况下，或者出于任何其他原因，当上传有问题时， `$cfg['TempDir']`参数可以使用临时目录的值进行设置。这可能是 phpMyAdmin 主目录的子目录，允许 web 服务器将上载的文件放入其中。

# 导入 SQL 文件

任何包含 MySQL 语句的文件都可以通过此机制导入。此格式更常用于备份/恢复目的。该对话框在 `Server`视图、 `Database`视图或 `Table`视图中，通过**导入**页面，或在查询窗口中可用。

![Importing SQL files](img/7782_07_01.jpg)

### 注

当前选择的表（此处为**作者】**与要导入的 SQL 文件的实际内容没有关系。SQL 文件的所有内容都将被导入，正是这些内容决定了哪些表或数据库受到影响。但是，如果导入的文件不包含任何用于选择数据库的 SQL 语句，则导入文件中的所有语句都将在当前选定的数据库上执行。

让我们试试导入练习。首先，我们确保有一个 `book`表的当前 SQL 导出文件（如[第 6 章](06.html "Chapter 6. Exporting Structure and Data (Backup)")中所述）。此导出文件必须包含结构和数据。然后我们放下桌子是的，真的！我们也可以简单地重命名它。（程序参见[第 9 章](09.html "Chapter 9. Performing Table and Database Operations")。

现在是将该文件导入回当前数据库的时候了（该文件可以导入到其他数据库中进行测试，甚至可以在另一台 MySQL 服务器上进行测试）。我们应该在**导入**页面，可以看到**文件导入**对话框。我们只需点击**浏览**按钮并选择我们的文件。

phpMyAdmin 能够检测对文件应用了哪种压缩方法（如果有的话）。根据 phpMyAdmin 版本和 web 服务器的 PHP 组件中可用的扩展，程序可以解压缩的格式会有所不同。

但是，要成功导入，必须通知 phpMyAdmin 要导入的文件的字符集。默认值为**utf-8**。但是，如果我们知道导入文件是用另一个字符集创建的，我们应该在这里指定它。

导入时提供**SQL 兼容模式**选择器。应根据先前导出数据的服务器类型，调整此模式以匹配我们将要导入的实际数据。

另一个选项**不使用零值自动增量**默认标记。如果主键中的值为零，并且希望它保持为零而不是自动递增，则应该使用此选项。

要开始导入，请单击**Go**。导入过程继续，我们收到一条消息：**导入已成功完成，执行了 2 个查询**。我们可以浏览新创建的表以确认导入操作的成功。

导入文件可能包含 `DELIMITER`关键字。这使得 phpMyAdmin 能够模拟 `mysql`命令行解释器。 `DELIMITER`分隔符用于描述文件中包含存储过程的部分，因为这些过程本身可以包含分号。

# 导入 CSV 文件

在本节中，我们将研究如何导入 CSV 文件。有两种可能的方法-**CSV**和**CSV 使用负载数据**。第一种方法是由 phpMyAdmin 在内部实现的，由于其简单性，推荐使用这种方法。使用第二种方法，phpMyAdmin 接收要加载的文件，并将其传递给 MySQL。理论上，这种方法应该更快。但是，由于 MySQL 本身的原因，它有更多的要求（请参考*CSV 使用负载数据*部分的*要求*小节）。

## SQL 和 CSV 格式之间的差异

通常，SQL 格式包含结构和数据。CSV 文件格式仅包含数据，因此如果我们在 `Table`视图中导入，我们必须已经有一个现有的表。该表不需要与原始表（数据来源）具有相同的结构；通过**列名**对话框，我们可以选择目标表中受影响的列。

从 3.4 版开始，我们还可以在 `Database`视图中导入 CSV 文件。在这种情况下，phpMyAdmin 检查 CSV 数据并生成一个表结构来保存该数据（具有通用列名，如 `COL 1, COL 2`和表名，如 `TABLE 24)`。

## 导出测试文件

在尝试导入之前，让我们从 `author`表生成一个 `author.csv`导出文件。我们在**CSV 导出**选项中使用默认值。然后，我们可以使用**清空**选项清空 `author`表。我们应该避免丢弃此表，因为我们仍然需要表结构。清空表的过程见[第 5 章](05.html "Chapter 5. Changing Data and Structure")中的*删除表*部分中的所有行。

### CSV

从 `author`表菜单中，我们选择**导入**，然后选择**CSV**。

![CSV](img/7782_07_02.jpg)

我们可以通过多种方式影响导入的行为。默认情况下，导入不会修改现有数据（基于主键或唯一键）。但是，**用文件**替换表数据选项指示 phpMyAdmin 使用 `REPLACE`语句而不是 `INSERT`语句，以便用导入的数据替换现有行。

使用**插入错误时不中止**，生成 `INSERT IGNORE`语句。这会导致 MySQL 在插入过程中忽略任何重复的密钥问题。导入文件中的重复密钥不会替换现有数据，下一行 CSV 数据将继续此过程。

然后，我们可以指定终止每列的字符、封闭数据的字符以及转义封闭字符的字符。通常这是**\**。

对于以选项终止的**行，应首先尝试**自动**选项，因为它会自动检测行尾字符。我们还可以手动指定哪些字符终止行。对于基于 UNIX 的系统，通常的选择是**\n**；对于 DOS 或 Windows 系统，通常的选择是**\r\n**；对于基于 Mac 的系统（直到 Mac OS 9），通常的选择是**\r**。如果有疑问，我们可以在客户端计算机（不是 phpMyAdmin 的一部分）上使用十六进制文件编辑器来检查确切的代码。**

默认情况下，phpMyAdmin 希望 CSV 文件具有与目标表相同的列数和列顺序。根据源文件格式，可通过在**列名**中输入以逗号分隔的列名列表进行更改。例如，假设源文件仅包含作者 ID 和作者姓名信息：

```php
"1","John Smith"
"2","Maria Sunshine"

```

我们必须将**id、名称**放在**列名**中，以匹配源文件。

当我们点击**Go**时，导入被执行，我们得到确认。如果文件的总大小不太大，我们还可能看到实际生成的 `INSERT`查询。

```php
Import has been successfully finished, 2 queries executed.
INSERT INTO `author` VALUES ('1', 'John Smith', '+01 445 789-1234'
)# 1 row(s) affected.
INSERT INTO `author` VALUES ('2', 'Maria Sunshine', '333-3333'
)# 1 row(s) affected.

```

## 使用负载数据的 CSV

使用此方法（仅在 `Table`视图中可用），phpMyAdmin 依赖服务器的 `LOAD DATA INFILE`或 `LOAD DATA LOCAL INFILE`机制进行实际导入，而不是在内部处理数据。这些语句是在 MySQL 中导入文本的最快方法。它们会导致 MySQL 从 MySQL 服务器 `(LOAD DATA INFILE)`上的文件或从另一个位置 `(LOAD DATA LOCAL INFILE)`开始读取操作，在此上下文中，该位置始终是 web 服务器的文件系统。如果 MySQL 服务器位于 web 服务器以外的计算机上，我们将无法使用 `LOAD DATA INFILE`机制。

### 要求

依赖 MySQL 服务器会产生一些后果。使用 `LOAD DATA INFILE`需要登录用户拥有全局 `FILE`权限。此外，MySQL 服务器进程必须能够读取文件本身。

### 注

[第 19 章](19.html "Chapter 19. Administrating the MySQL Server")介绍了 phpMyAdmin 的接口，系统管理员可以使用该接口来管理权限。

PHP 使用的 MySQL 服务器和 MySQL 客户端库必须允许使用 `LOAD DATA LOCAL INFILE`中的 `LOCAL`修饰符。

两种 `LOAD`方法都可以从 phpMyAdmin `LOAD`接口获得，该接口尝试选择最佳的默认选项。

### 使用负载数据接口

我们从 `author`表菜单中选择**导入**。选择**CSV using LOAD DATA**选项将弹出以下对话框：

![Using the LOAD DATA interface](img/7782_07_03.jpg)

### 注

可用选项已包含在*CSV*部分中。

在**文件导入**部分，我们选择我们的 `author.csv`文件。

最后，如前所述，我们可以通过选择**使用本地关键字**选项来选择 `LOAD`方法。然后点击**Go**。

如果一切顺利，我们可以看到确认屏幕，如以下屏幕截图所示：

![Using the LOAD DATA interface](img/7782_07_04.jpg)

此屏幕显示所使用的确切的**负载数据本地填充**语句。发生的事情如下：

1.  我们选择了**author.csv**。
2.  此文件的内容通过 HTTP 传输并由 web 服务器接收。
3.  web 服务器中的 PHP 组件将该文件保存在一个工作目录中（此处为 `/opt/php-upload-tmp/)`，并为其指定了一个临时名称）。
4.  phpMyAdmin 知道了这个工作文件的位置，构建了一个 `LOAD DATA LOCAL INFILE`命令，并将其发送到 MySQL。请注意，只执行了一个查询，它加载了许多行。
5.  MySQL 服务器读取文件内容并将其加载到我们的目标表中。然后返回 phpMyAdmin 在结果页面上显示的受影响行数**（2）**。

# 导入其他格式

除了 SQL 和 CSV 格式外，phpMyAdmin 还可以导入打开的文档电子表和 XML 文件。但是，这些文件需要由 phpMyAdmin 本身导出，或者严格遵循 phpMyAdmin 在导出时的操作。

## 打开文档电子表

默认情况下，当我们以这种格式通过 phpMyAdmin 导出时，**将列名放在第一行**选项没有标记。这意味着导出的文件仅包含数据。导入时，会提供相应的选项**文件的第一行包含表列名**，如果文件的第一行不包含列名，则不应标记该选项。

但是，如果导出的文件确实包含列名，则可以选中此选项。因此，当从 `Database`视图导入时，phpMyAdmin 将执行以下操作：

1.  创建一个表，使用文件名`(author.ods)` 作为表名`(author)` 。
2.  使用第一行的列名作为此表的列名。
3.  根据数据本身确定每列的类型和适当大小。
4.  将数据插入表中。

如果我们在 `Table`视图中，则只导入数据。

存在其他导入选项来指示应如何处理空行和包含百分比或货币值的数据。

## XML

通过导入 XML 文件可以创建的结构信息量取决于导出时选择的选项。事实上，如果选择了**对象创建选项**对话框中的**表**选项，则确切的 `CREATE TABLE`语句将放在导出的文件中。因此，在还原的表中可以使用相同的表结构。

同样，如果标记了**导出内容**选项，则整个数据都在 XML 文件中，可以重新导入。导入时没有可用的选项，因为 XML 是一种自描述格式；因此，phpMyAdmin 可以正确解释文件中的内容并做出适当的反应。

由于原始数据库名称是 XML 导出的一部分，因此当前 phpMyAdmin 版本仅支持将 XML 文件导入导出源的数据库。要导入到其他数据库，我们需要首先使用文本编辑器，并在以下行中更改数据库名称：

```php
<pma:database name="marc_book" collation="latin1_swedish_ci" charset="latin1">

```

# 从 web 服务器上传目录读取文件

为了避免 web 服务器的 PHP 配置完全禁用上载，或者上载限制太小的情况，phpMyAdmin 可以从 web 服务器文件系统上的特殊目录读取上载文件。

我们首先在 `$cfg['UploadDir']`参数中指定我们选择的目录名，例如`'./upload'`。我们也可以使用[第 6 章](06.html "Chapter 6. Exporting Structure and Data (Backup)")中所述的 `%u`字符串来表示用户名。

现在，让我们回到**导入**页面。我们收到一条错误消息：

**无法访问您为上传工作设置的目录**。

由于目录不存在，应显示此错误消息。应该是在当前 `phpMyAdmin`安装目录中创建的。该消息还可能指示目录存在，但 web 服务器无法读取该目录。

### 注

在 PHP 安全模式下，目录的所有者和 phpMyAdmin 安装脚本的所有者必须相同。

使用 SFTP 或 FTP 客户端，我们创建必要的目录，现在可以在那里上传文件（例如，**book.sql）**绕过任何 PHP 超时或上传最大限制。

### 提示

请注意，文件本身必须具有允许 web 服务器读取它的权限。

在大多数情况下，最简单的方法是允许每个人都读取该文件。

刷新**导入**页面将显示以下屏幕截图：

![Reading files from a web server upload directory](img/7782_07_05.jpg)

点击**Go**应执行文件中的语句。

自动解压缩也可用于位于上载目录中的文件。文件名应具有扩展名，如 `.bz2, .gz, .sql.bz2`或 `.sql.gz`。

### 注

使用双扩展名`(.sql.bz2)`是一种更好的方式，表明生成了 `.sql`文件，然后进行了压缩，正如我们看到的生成此文件的所有步骤一样。

# 显示上传进度条

特别是在导入大文件时，有一个关于上传进度的视觉反馈是很有趣的。请注意，我们在这里讨论的进度条只通知我们上载部分，这是整个导入操作的子集。

启用 JavaScript 浏览器是此功能的一项要求。此外，web 服务器的 PHP 组件必须具有 JSON 扩展和至少一个以下扩展：

*   众所周知的 APC 扩展（[http://pecl.php.net/package/APC](http://pecl.php.net/package/APC) ），由于其操作码缓存优势，强烈推荐使用
*   `uploadprogress`分机（[http://pecl.php.net/package/uploadprogress](http://pecl.php.net/package/uploadprogress)

phpMyAdmin 使用 AJAX 技术获取进度信息，然后将其显示为要导入对话框的**文件的一部分。上载的字节数、总字节数和上载的百分比显示在该栏下。**

## 配置 APC

一些 `php.ini`指令对上传进度起着重要作用。首先， `apc.rfc1867`指令必须设置为 `On`或 `true`，否则此扩展将不会向调用脚本报告上载进度。当设置为 `On`时，此扩展使用上载状态信息更新 APC 用户缓存条目。

此外，可以通过 `apc.rfc1867_freq`指令设置更新频率，该指令可以采用总文件大小的百分比形式（例如， `apc.rfc1867_freq = "10%")`或字节大小（接受后缀 `k`表示千字节， `m`表示兆字节， `g`表示千兆字节）。值为 `0`这里指示我们尽可能经常更新，这看起来很有趣，但实际上可能会减慢上传速度。

这种更新频率的概念解释了为什么在使用这种机制时，条会以块的形式而不是连续地进行。

# 总结

本章包括：

*   phpMyAdmin 中允许我们导入数据的各种选项
*   导入文件所涉及的不同机制
*   尝试转移时可能遇到的限制，以及绕过这些限制的方法

下一章将解释如何进行单表搜索（涵盖搜索条件规范）以及如何在整个数据库中搜索。